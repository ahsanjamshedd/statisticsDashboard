<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Schedule Campaign — Ground Update</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css" />
    <style>
      .panel{background:#fff;border-radius:10px;padding:14px;border:1px solid #eef2f7}
      .weekday {border:1px solid #e6edf6;padding:.4rem .6rem;border-radius:6px;cursor:pointer}
      .weekday.active{background:#eef7ff;border-color:#cfe3ff}
      .summary-box{background:#f1f6ff;border-radius:8px;padding:12px;border:1px solid #e6eef7}
      .small-muted{font-size:.85rem;color:#6b7280}
    </style>
  </head>
  <body>
    <div id="site-header"></div>
    <script>
      // Dynamically load the site header
      fetch('header.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('site-header').innerHTML = data;
        });
    </script>

    <div class="card shadow-lg border-0 rounded-4 mx-auto" style="max-width:1700px;background:#f7fafd;">
      <main class="dashboard-inner-content px-4 py-3 w-100" style="max-width:1500px;margin:auto;">
      <h4 class="mb-3">Schedule Campaign</h4>
      <div class="panel mb-3">
        <div class="mb-3 small-muted">When to Send</div>
        <div class="mb-3">
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="whenSend" id="sendNow" value="now">
            <label class="form-check-label" for="sendNow">Send Immediately</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="whenSend" id="scheduleLater" value="later" checked>
            <label class="form-check-label" for="scheduleLater">Schedule for Later</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="whenSend" id="recurring" value="recurring">
            <label class="form-check-label" for="recurring">Recurring Schedule</label>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label small">Start Date</label>
            <input id="startDate" type="date" class="form-control form-control-sm" />
          </div>
          <div class="col-md-4">
            <label class="form-label small">Start Time</label>
            <input id="startTime" type="time" class="form-control form-control-sm" />
          </div>
        </div>

        <div id="recurringOptions" class="mb-3" style="display:none">
          <div class="mb-2 small-muted">For Recurring Campaigns</div>
          <div class="row g-2 mb-2">
            <div class="col-md-4">
              <label class="form-label small">Frequency</label>
              <select id="recurrenceFreq" class="form-select form-select-sm">
                <option>Weekly</option>
                <option>Daily</option>
                <option>Monthly</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label small">Repeat on</label>
              <div class="d-flex gap-2 mt-1" id="weekdays">
                <div class="weekday" data-day="Mon">Mon</div>
                <div class="weekday" data-day="Tue">Tue</div>
                <div class="weekday" data-day="Wed">Wed</div>
                <div class="weekday" data-day="Thu">Thu</div>
                <div class="weekday" data-day="Fri">Fri</div>
                <div class="weekday" data-day="Sat">Sat</div>
                <div class="weekday" data-day="Sun">Sun</div>
              </div>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label small">End</label>
            <div class="d-flex gap-3 align-items-center mt-1">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="endType" value="never" id="endNever" checked>
                <label class="form-check-label" for="endNever">Never</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="endType" value="after" id="endAfter">
                <label class="form-check-label" for="endAfter">After</label>
                <input id="afterCount" type="number" min="1" class="form-control form-control-sm ms-2" style="width:100px" placeholder="occurrences">
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="endType" value="on" id="endOn">
                <label class="form-check-label" for="endOn">On date</label>
                <input id="endDate" type="date" class="form-control form-control-sm ms-2" style="width:160px">
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label small">Message Settings</label>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label small">Max delivery attempts per recipient</label>
              <select id="maxAttempts" class="form-select form-select-sm">
                <option>1</option>
                <option selected>3</option>
                <option>5</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label small">Time between attempts</label>
              <select id="timeBetween" class="form-select form-select-sm">
                <option>1 hour</option>
                <option selected>2 hours</option>
                <option>4 hours</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label small">Daily send window</label>
              <div class="d-flex gap-2">
                <input id="callWindowStart" type="time" class="form-control form-control-sm" value="09:00">
                <input id="callWindowEnd" type="time" class="form-control form-control-sm" value="18:00">
              </div>
            </div>
          </div>
        </div>

        <div class="mt-3 summary-box">
          <strong>Campaign Summary</strong>
          <div id="summaryContent" class="mt-2 small-muted">
            Loading draft...
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <a href="ground-update-message.html" class="btn btn-outline-secondary">← Previous</a>
          <div>
            <button id="saveDraft" class="btn btn-outline-primary me-2">Save as Draft</button>
            <button id="launchCampaign" class="btn btn-success">Launch Campaign</button>
          </div>
        </div>
      </div>
      </main>
    </div>

    <script>
      function loadDraft(){
        const draft = JSON.parse(localStorage.getItem('groundUpdateDraft') || 'null') || {};
        // populate some defaults
        const today = new Date().toISOString().slice(0,10);
        document.getElementById('startDate').value = draft.startDate || today;
        document.getElementById('startTime').value = draft.startTime || '10:00';
        if (draft.whenSend === 'now') document.getElementById('sendNow').checked = true;
        if (draft.whenSend === 'recurring') document.getElementById('recurring').checked = true;
        if (draft.whenSend === 'later' || !draft.whenSend) document.getElementById('scheduleLater').checked = true;

        if (draft.recurrence) {
          document.getElementById('recurrenceFreq').value = draft.recurrence.freq || 'Weekly';
          (draft.recurrence.days||[]).forEach(d=>{
            const el = document.querySelector(`#weekdays .weekday[data-day="${d}"]`);
            if (el) el.classList.add('active');
          });
        }

        if (draft.endType) {
          const el = document.querySelector(`input[name="endType"][value="${draft.endType}"]`);
          if (el) el.checked = true;
        }
        if (draft.afterCount) document.getElementById('afterCount').value = draft.afterCount;
        if (draft.endDate) document.getElementById('endDate').value = draft.endDate;

        if (draft.callSettings) {
          document.getElementById('maxAttempts').value = draft.callSettings.maxAttempts || '3';
          document.getElementById('timeBetween').value = draft.callSettings.timeBetween || '2 hours';
          document.getElementById('callWindowStart').value = draft.callSettings.windowStart || '09:00';
          document.getElementById('callWindowEnd').value = draft.callSettings.windowEnd || '18:00';
        }

        updateRecurringVisibility();
        renderSummary(draft);
      }

      function updateRecurringVisibility(){
        const isRecurring = document.getElementById('recurring').checked;
        document.getElementById('recurringOptions').style.display = isRecurring ? 'block' : 'none';
      }

      document.querySelectorAll('input[name="whenSend"]').forEach(r => r.addEventListener('change', updateRecurringVisibility));

      document.querySelectorAll('#weekdays .weekday').forEach(w => {
        w.addEventListener('click', ()=>{
          w.classList.toggle('active');
        });
      });

      function renderSummary(draft){
        const lines = [];
        lines.push(`<div>Type: <strong>${draft.whenSend || 'Scheduled'}</strong></div>`);
        lines.push(`<div>Recipients: <strong>~3,456 farmers</strong></div>`);
        lines.push(`<div>Location: <strong>${draft.geometry ? 'Selected' : 'Not specified'}</strong></div>`);
        const sched = (draft.whenSend==='now') ? 'Immediately' : (draft.whenSend==='recurring' ? (draft.recurrence?.freq || 'Weekly') : (draft.startDate || '') + ' ' + (draft.startTime || ''));
        lines.push(`<div>Schedule: <strong>${sched}</strong></div>`);
        lines.push(`<div>Estimated Cost: <strong>PKR 10,368 per execution</strong></div>`);
        document.getElementById('summaryContent').innerHTML = lines.join('');
      }

      function saveScheduleDraft(){
        const draft = JSON.parse(localStorage.getItem('groundUpdateDraft') || '{}');
        draft.whenSend = document.querySelector('input[name="whenSend"]:checked').value;
        draft.startDate = document.getElementById('startDate').value;
        draft.startTime = document.getElementById('startTime').value;
        draft.recurrence = { freq: document.getElementById('recurrenceFreq').value, days: Array.from(document.querySelectorAll('#weekdays .weekday.active')).map(e=>e.dataset.day) };
        const endType = document.querySelector('input[name="endType"]:checked')?.value || 'never';
        draft.endType = endType;
        draft.afterCount = document.getElementById('afterCount').value;
        draft.endDate = document.getElementById('endDate').value;
        draft.callSettings = { maxAttempts: document.getElementById('maxAttempts').value, timeBetween: document.getElementById('timeBetween').value, windowStart: document.getElementById('callWindowStart').value, windowEnd: document.getElementById('callWindowEnd').value };
        localStorage.setItem('groundUpdateDraft', JSON.stringify(draft));
        renderSummary(draft);
        return draft;
      }

      document.getElementById('saveDraft').addEventListener('click', ()=>{
        saveScheduleDraft();
        alert('Draft saved.');
      });

      document.getElementById('launchCampaign').addEventListener('click', ()=>{
        const draft = saveScheduleDraft();
        // In a real app we would POST the draft to an API and schedule the campaign.
        // For this prototype: persist last launched campaign, clear draft and redirect to monitoring page
        try{
          localStorage.setItem('lastLaunchedCampaign', JSON.stringify(draft));
        }catch(e){
          console.warn('Could not persist lastLaunchedCampaign', e);
        }
        alert('Campaign launched (prototype). Redirecting to Campaign Monitoring dashboard.');
        // clear draft
        localStorage.removeItem('groundUpdateDraft');
        // go to monitoring page
        window.location.href = 'campaign-monitoring.html';
      });

      // show/hide recurring options on load
      loadDraft();
    </script>
  </body>
</html>
